# Feature Specification: 批量 Spec 生成体验优化

**Feature Branch**: `006-batch-progress-timeout`
**Created**: 2026-02-14
**Status**: Draft
**Input**: User description: "批量 spec 生成体验优化：添加模块内细粒度进度报告，优化大模块超时策略"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 模块处理过程实时进度可见 (Priority: P1)

用户在执行批量 spec 生成时，希望看到每个模块处理过程中的各阶段进度信息（如 AST 提取中、上下文组装中、LLM 调用中），而不是只能看到模块开始和结束两个时间点。当前 batch 处理的大模块可能耗时数分钟，用户在这段时间内完全看不到任何输出，不知道是卡住了还是正在正常工作。

**Why this priority**: 这是用户反馈的首要痛点——不知道系统在干什么。进度信息能消除焦虑、帮助定位问题，是最基础的体验提升。

**Independent Test**: 可通过对任意模块执行 batch 生成并观察终端输出来独立测试。每个阶段（文件扫描、AST 分析、上下文组装、LLM 调用、响应解析、渲染写入）均应有独立的进度行输出。

**Acceptance Scenarios**:

1. **Given** 用户启动批量 spec 生成，**When** 某模块正在处理中，**Then** 终端依次输出各阶段的进度信息（如 "  → AST 分析中 (12 个文件)..."、"  → LLM 调用中..."），每个阶段完成时输出耗时
2. **Given** 用户启动批量 spec 生成，**When** LLM 调用正在进行中，**Then** 用户能看到该阶段正在执行的提示（区别于"卡住"的静默状态）
3. **Given** 某模块处理出错触发重试，**When** 进入重试循环，**Then** 进度信息显示当前重试次数（如 "  ↻ 重试 2/3..."）

---

### User Story 2 - 大模块快速失败而非长时间等待 (Priority: P1)

用户在处理大模块（如 shared，包含大量文件）时，由于上下文过大导致 LLM 调用反复超时。当前最坏情况下需要等待 ~18 分钟（120s 超时 × 3 次 LLM 内部重试 × 3 次模块级重试）才会最终报告失败。用户希望系统能尽早识别问题并快速失败，而不是浪费时间反复超时。

**Why this priority**: 与 P1-US1 同等重要。18 分钟等待一个注定失败的模块，严重影响整体 batch 的吞吐效率和用户体验。

**Independent Test**: 可通过对一个已知超大模块执行 spec 生成并测量从开始到报告失败的总耗时来验证。优化后的失败耗时应显著低于当前水平。

**Acceptance Scenarios**:

1. **Given** 某模块的上下文 token 数超过预设阈值，**When** 系统检测到此情况，**Then** 在发送 LLM 请求前预先输出警告信息，提示上下文过大可能影响质量
2. **Given** 某模块的 LLM 调用首次超时，**When** 系统决定是否重试，**Then** 系统对"超时"类失败采用更保守的重试策略（减少无意义的重试次数），避免反复等待相同的超时结果
3. **Given** 某模块的 LLM 调用在所有尝试中均超时失败，**When** 最终确认失败，**Then** 系统自动降级为 AST-only 输出，而非直接标记为 failed 丢弃该模块

---

### User Story 3 - 进度条反映真实处理进度 (Priority: P2)

用户看到的进度条（如 `[=                   ] 3/49`）目前仅在模块完成后更新。希望进度条能更频繁地更新，反映模块内部的实际处理阶段，让用户对整体进度有更准确的感知。

**Why this priority**: 进度条是用户感知整体进度的关键 UI 元素，但当前粒度太粗，模块处理期间完全静止。虽然模块内进度信息（US1）已经部分缓解了这个问题，但进度条本身的更新频率也应改善。

**Independent Test**: 观察终端中进度条在模块处理过程中是否有阶段性更新（如半完成态），而非仅在模块完成时跳变。

**Acceptance Scenarios**:

1. **Given** 用户启动 batch 处理，**When** 某模块的 AST 分析和上下文组装完成（即 LLM 调用前），**Then** 进度条有中间状态的视觉反馈，而非仅在模块完成后整体跳变

---

### Edge Cases

- 当模块只包含 1 个文件时，文件扫描和 AST 分析阶段的进度信息应简洁，不显示冗余信息
- 当 LLM 触发速率限制（429）等待退避延迟时，进度信息应提示用户正在等待（如 "  ⏳ 速率限制，等待 4s 后重试..."）
- 当断点恢复跳过已完成模块时，跳过的模块不应输出内部阶段进度信息，仅输出跳过提示
- 当模块降级为 AST-only 时，进度信息应清晰标识降级原因

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 在模块处理的每个关键阶段输出进度信息，至少包含：文件扫描、AST 分析、上下文组装、LLM 调用、响应解析、渲染写入 6 个阶段
- **FR-002**: 每条阶段进度信息 MUST 包含阶段名称和相关上下文（如文件数量、token 数等）
- **FR-003**: 每条阶段完成时 MUST 输出该阶段耗时
- **FR-004**: 当模块处理触发重试时，系统 MUST 在进度信息中显示重试次数和重试原因
- **FR-005**: 当 LLM 调用因超时触发重试时，系统 MUST 减少重试次数（超时类错误最多重试 1 次，而非默认的 3 次），以实现快速失败
- **FR-006**: 当模块最终因 LLM 超时或不可用而失败时，系统 MUST 自动降级为 AST-only 输出（而非直接标记失败），保证每个模块至少有基础 spec 输出
- **FR-007**: 当组装好的上下文 token 数超过预设阈值时，系统 MUST 在 LLM 调用前输出警告信息
- **FR-008**: 当 LLM 调用触发速率限制并等待退避延迟时，系统 MUST 在进度信息中提示等待状态和预计等待时间
- **FR-009**: 进度报告器接口 MUST 新增支持阶段级别的事件通知方法，供模块处理流水线回调

### Key Entities

- **StageProgress**: 表示模块处理中某一阶段的进度事件，包含阶段名、描述信息、耗时等
- **RetryEvent**: 表示重试事件，包含当前重试次数、错误类型、等待时间等

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在模块处理过程中能看到至少 4 条阶段进度信息（区别于当前的 0 条中间输出）
- **SC-002**: 大模块（上下文 token 数超过阈值）从开始处理到最终出结果（含降级）的最大耗时不超过 5 分钟（当前最坏 ~18 分钟）
- **SC-003**: 所有模块在 batch 完成后至少有 AST-only 级别的 spec 输出，不存在完全无产出的 failed 模块
- **SC-004**: 用户能根据进度信息区分"正常处理中"与"卡住/超时"两种状态

## Assumptions

- 进度信息以文本行形式直接输出到终端（console.log），保持与现有输出风格一致，不引入额外的终端 UI 库
- "大模块"的 token 阈值沿用现有 context-assembler 中的 100,000 token 预算作为参考
- 降级为 AST-only 的模块在摘要中标记为 "degraded" 状态，不影响其他模块的处理
- 超时重试策略的优化仅影响超时类错误，其他可重试错误（如 429 速率限制）保持现有重试策略不变
